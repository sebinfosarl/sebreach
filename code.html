<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Free IPTV Trial</title>
  <style>
    :root { --bg:#0f1115; --card:#151922; --muted:#2a3040; --text:#e6e8ec; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:var(--bg);color:var(--text);margin:0}
    .wrap{max-width:720px;margin:40px auto;padding:24px;background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.3)}
    h1{margin:0 0 8px}
    p.lead{margin:0 0 18px;opacity:.9}
    label{display:block;margin:12px 0 6px}
    input,select,button,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid var(--muted);background:var(--bg);color:var(--text)}
    button{cursor:pointer;font-weight:700;margin-top:14px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > div{flex:1 1 220px}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
    .hide{display:none !important}
    .card{border:1px solid var(--muted);border-radius:12px;padding:14px;margin-top:14px}
    .title{font-weight:700;margin-bottom:8px}
    .small{font-size:12px;opacity:.8}
    .ok{background:#0f1f14;color:#c9ffdf;border:1px solid #1f3a28;padding:12px;border-radius:10px;margin-top:12px}
    .error{background:#2b1212;color:#ffd7d7;border:1px solid #442222;padding:12px;border-radius:10px;margin-top:12px;white-space:pre-wrap}
    .section-heading{margin-top:18px;margin-bottom:6px;font-weight:700}
    pre{margin:8px 0 0; background:#0b0d12; border:1px solid var(--muted); border-radius:8px; padding:10px; overflow:auto}
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .kv{margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Get Your Free IPTV Trial</h1>
    <p class="lead"><small>No payment. Instant temporary credentials.</small></p>

    <form id="trialForm" autocomplete="off" novalidate>
      <div class="hide">
        <label>Leave this empty</label>
        <input name="hp" value="">
      </div>

      <label>Email</label>
      <input type="email" name="email" required placeholder="you@example.com" inputmode="email" autocomplete="email">

      <div class="row">
        <div>
          <label>Country (ISO-2)</label>
          <input name="country" placeholder="MA" maxlength="3">
          <div class="hint">Examples: MA, FR, US</div>
        </div>
        <div>
          <label>Auto Mode</label>
          <select name="auto">
            <option value="1" selected>ON (fast & automatic)</option>
            <option value="0">OFF (manual)</option>
          </select>
          <div class="hint">AUTO tries multiple package/type/bouquet combos until one works.</div>
        </div>
      </div>

      <div id="manualPanel" class="hide">
        <div class="row">
          <div>
            <label>Type (manual)</label>
            <select name="type">
              <option value="1">1 — M3U</option>
              <option value="2">2 — MAG</option>
              <option value="3">3 — E2</option>
              <option value="4">4 — Protocol</option>
            </select>
          </div>
          <div>
            <label>Package ID (manual)</label>
            <input name="pkg" placeholder="e.g. 6">
          </div>
        </div>

        <div id="macWrap" class="hide">
          <label>MAC (for MAG/E2)</label>
          <input name="mac" placeholder="00:11:22:33:44:55"
                pattern="^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$"
                title="Use format XX:XX:XX:XX:XX:XX">
          <div class="hint">Format: XX:XX:XX:XX:XX:XX</div>
        </div>

        <label>Bouquet IDs (optional JSON array)</label>
        <textarea name="bouquet" placeholder='e.g. [48704]'></textarea>
        <div class="hint">Leave empty if not needed.</div>
      </div>

      <button id="submitBtn" type="submit">Create Trial</button>
    </form>

    <div id="result"></div>
  </div>

  <script>
    const WORKER_URL = "https://divine-disk-ff57.restless-cell-d69c.workers.dev/"; // your Worker

    const form = document.getElementById('trialForm');
    const result = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');

    const pageLoadedAt = Date.now();
    const autoSel = form.elements['auto'];
    const manualPanel = document.getElementById('manualPanel');
    const typeSel = form.elements['type'];
    const macWrap = document.getElementById('macWrap');
    const macInput = form.elements['mac'];

    function togglePanels() {
      const auto = autoSel.value === "1";
      manualPanel.classList.toggle('hide', auto);
      toggleMac();
    }
    function toggleMac() {
      const auto = autoSel.value === "1";
      const t = parseInt(typeSel?.value || "1", 10);
      const needMac = (!auto && (t === 2 || t === 3));
      macWrap.classList.toggle('hide', !needMac);
      if (macInput) macInput.required = needMac;
    }
    autoSel.addEventListener('change', togglePanels);
    typeSel?.addEventListener('change', toggleMac);
    togglePanels();

    function renderError(msg, details) {
      result.innerHTML = `<div class="error"><strong>Error:</strong> ${msg}${details ? `\n${details}` : ""}</div>`;
    }
    function safeUrlOrigin(u) { try { return new URL(u).origin; } catch { return ""; } }

    function renderM3U(username, password, url) {
      const origin = safeUrlOrigin(url);
      return `
        <div class="ok"><strong>Trial created successfully.</strong></div>
        <div class="section-heading">M3U</div>
        <div class="card"><div class="kv"><div class="title">M3U Link</div>
          <pre><code>${url || "-"}</code></pre></div></div>
        <div class="section-heading">Xtream API</div>
        <div class="card">
          <div class="kv"><div class="title">URL</div><pre><code>${origin || "-"}</code></pre></div>
          <div class="kv"><div class="title">Username</div><pre><code>${username || "-"}</code></pre></div>
          <div class="kv"><div class="title">Password</div><pre><code>${password || "-"}</code></pre></div>
          <div class="small">Use these in Xtream-compatible apps (e.g., Smarters: Login with Xtream Codes).</div>
        </div>`;
    }
    function renderDevice(ident, portalUrl) {
      return `
        <div class="ok"><strong>Trial created successfully.</strong></div>
        <div class="section-heading">Device Access</div>
        <div class="card">
          <div class="kv"><div class="title">Identifier</div><pre><code>${ident || "-"}</code></pre></div>
          <div class="kv"><div class="title">Portal / URL</div><pre><code>${portalUrl || "-"}</code></pre></div>
        </div>`;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      result.innerHTML = "";
      const email = form.elements['email'].value.trim();
      if (!email) return renderError('Email is required');

      const auto = autoSel.value === "1";
      const country = (form.elements['country'].value || 'MA').trim().toUpperCase();

      const body = { email, country, hp: "", ts: pageLoadedAt, auto };

      if (!auto) {
        const type = parseInt(typeSel.value, 10);
        const pkgRaw = form.elements['pkg']?.value.trim();
        if (!pkgRaw || !/^\d+$/.test(pkgRaw)) {
          return renderError("Package ID (manual) is required and must be numeric.");
        }
        body.type = type;
        body.package = parseInt(pkgRaw, 10);
        if (type === 2 || type === 3) {
          const mac = macInput.value.trim();
          if (!mac) return renderError("MAC is required for MAG/E2 in manual mode.");
          body.mac = mac;
        }
        const bqRaw = form.elements['bouquet']?.value.trim();
        if (bqRaw) {
          try {
            const parsed = JSON.parse(bqRaw);
            if (Array.isArray(parsed)) body.bouquet = parsed;
            else throw new Error("must be JSON array");
          } catch (err) {
            return renderError("Bouquet parse error", String(err));
          }
        }
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "Working…";
      result.innerHTML = `<div class="card"><span class="small">Creating your trial…</span></div>`;

      try {
        const res = await fetch("https://divine-disk-ff57.restless-cell-d69c.workers.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=>null);

        if (!res.ok) {
          renderError(data?.error || 'Unknown', typeof data?.details === 'string' ? data.details : JSON.stringify(data?.details||'', null, 2));
          return;
        }

        // Decide how to render
        const url = data.url || "";
        let username = data.username || "";
        let password = data.password || "";

        if ((!username || !password) && url) {
          try {
            const u = new URL(url);
            username = username || u.searchParams.get("username") || "";
            password = password || u.searchParams.get("password") || "";
          } catch {}
        }

        // If we have a full M3U link OR both username/password: render M3U/Xtream
        if (url || (username && password)) {
          result.innerHTML = renderM3U(username, password, url);
        } else {
          // Otherwise treat as device/portal style
          result.innerHTML = renderDevice(username, url);
        }

      } catch (err) {
        renderError("Network/CORS error. Check HTTPS and SUBS_API_KEY on the Worker.");
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Create Trial";
      }
    });

    // Optional echo check on load
    fetch("https://divine-disk-ff57.restless-cell-d69c.workers.dev/_echo")
      .then(r=>r.json()).then(console.log).catch(()=>{});
  </script>
</body>
</html>
