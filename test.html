<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extracteur MAC / Device Key depuis image</title>
  <meta name="description" content="Chargez une image d'écran IPTV et extrayez automatiquement le site web, l'adresse MAC, la clé appareil et l'ID." />
  <style>
    :root { --bg:#0f1115; --card:#161a23; --text:#e9eef5; --muted:#9aa3b2; --accent:#4f8cff; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .container{max-width:980px;margin:32px auto;padding:16px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 6px}
    p.lead{margin:0 0 14px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width: 900px){ .row{grid-template-columns:1fr 1fr} }
    .drop{border:2px dashed rgba(255,255,255,.15);border-radius:14px;padding:18px;text-align:center;cursor:pointer}
    .drop.drag{border-color:var(--accent);background:#0e1320}
    .muted{color:var(--muted);font-size:13px}
    button{cursor:pointer;border:0;border-radius:10px;padding:10px 14px;font-weight:600;color:white;background:var(--accent)}
    button.secondary{background:#2a3144}
    .grid{display:grid;grid-template-columns:160px 1fr;gap:10px;margin-top:12px}
    .value{background:#0e1118;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    img#preview{max-width:100%;border-radius:10px}
    .copybtn{margin-left:8px;padding:6px 10px;font-size:12px;border-radius:8px}
  </style>
  <!-- Tesseract.js (WebAssembly OCR, runs locally) -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>Extraction depuis capture d’écran IPTV</h1>
    <p class="lead">Charge une image (JPG/PNG) d’écran d’une app (iboproapp / shamel / ibsmarterplayer, etc.) et récupère automatiquement : <b>Site</b>, <b>Adresse MAC</b>, <b>Clé de l’appareil</b>, <b>Device ID</b> (si présent).</p>

    <div class="row">
      <div>
        <label class="muted">Image</label>
        <div id="drop" class="drop">
          Glissez-déposez ici ou <u>cliquez pour choisir</u><br/>
          <input id="file" type="file" accept="image/*" hidden>
        </div>
        <div style="margin-top:10px"><img id="preview" alt=""></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="run">Extraire</button>
          <button id="clear" class="secondary">Effacer</button>
          <span id="status" class="muted">Prêt.</span>
        </div>
      </div>

      <div>
        <label class="muted">Résultat</label>
        <div class="grid">
          <div>Site</div>
          <div><span id="site" class="value"></span><button class="copybtn secondary" data-copy="#site">Copier</button></div>

          <div>Adresse MAC</div>
          <div><span id="mac" class="value"></span><button class="copybtn secondary" data-copy="#mac">Copier</button></div>

          <div>MAC (sans « : »)</div>
          <div><span id="macplain" class="value"></span><button class="copybtn secondary" data-copy="#macplain">Copier</button></div>

          <div>Clé appareil</div>
          <div><span id="dkey" class="value"></span><button class="copybtn secondary" data-copy="#dkey">Copier</button></div>

          <div>Device ID</div>
          <div><span id="did" class="value"></span><button class="copybtn secondary" data-copy="#did">Copier</button></div>

          <div>Texte OCR (debug)</div>
          <div><textarea id="raw" class="value" style="height:160px"></textarea></div>
        </div>
      </div>
    </div>

    <p class="muted" style="margin-top:14px">Tout se passe <b>localement</b> dans votre navigateur. Aucun envoi vers un serveur.</p>
  </div>
</div>

<script>
const el = (sel)=> document.querySelector(sel);
const statusEl = el('#status');
const siteEl = el('#site'), macEl = el('#mac'), macPlainEl = el('#macplain');
const dkeyEl = el('#dkey'), didEl = el('#did'), rawEl = el('#raw');
const fileInput = el('#file'), drop = el('#drop'), preview = el('#preview');

function setStatus(text, cls=''){ statusEl.className='muted ' + (cls||''); statusEl.textContent=text; }
function copyFrom(sel){
  const node = el(sel); if(!node) return;
  const txt = (node.tagName === 'TEXTAREA' || node.tagName === 'INPUT') ? node.value : node.textContent;
  navigator.clipboard?.writeText(txt);
}
document.addEventListener('click', e=>{
  const b = e.target.closest('[data-copy]'); if(!b) return;
  copyFrom(b.getAttribute('data-copy')); setStatus('Copié !','ok'); setTimeout(()=>setStatus('Prêt.'),900);
});

function resetOut(){
  siteEl.textContent = macEl.textContent = macPlainEl.textContent = dkeyEl.textContent = didEl.textContent = rawEl.value = '';
}

function readFile(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function runOCR(){
  resetOut();
  const file = fileInput.files?.[0];
  if(!file){ setStatus('Choisissez une image.', 'warn'); return; }
  preview.src = URL.createObjectURL(file);

  setStatus('OCR en cours… (~5–10s la première fois)');
  const { data } = await Tesseract.recognize(file, 'eng+fra', {
    logger: m => { /* console.log(m); */ }
  });
  const text = (data && data.text || '').replace(/\s+/g,' ').trim();
  rawEl.value = text;
  setStatus('Texte détecté. Extraction…');

  // ---- Extraction heuristics ----
  // URL
  const urlMatch = text.match(/\bhttps?:\/\/[a-z0-9._\-\/]+/i);
  siteEl.textContent = urlMatch ? urlMatch[0] : '';

  // MAC (accepts hex pairs with : or - ; allow a–f / 0–9, sometimes OCR confuses O/0 or l/1)
  // First, normalize common OCR confusions
  const norm = text
    .replace(/O/g,'0')
    .replace(/l/g,'1')
    .replace(/I/g,'1')
    .replace(/—|–/g,'-');

  const macMatch = norm.match(/\b([0-9a-fA-F]{2}[:\-]){5}[0-9a-fA-F]{2}\b/);
  const mac = macMatch ? macMatch[0].replace(/-/g,':').toLowerCase() : '';
  macEl.textContent = mac;
  macPlainEl.textContent = mac ? mac.replace(/:/g,'').toUpperCase() : '';

  // Device Key (usually 5–7 digits)
  const keyMatch = norm.match(/\b(?:clé\s*(?:de|l’|l')\s*(?:appareil|device)\s*[:\-]?\s*)?(\d{5,7})\b/i);
  dkeyEl.textContent = keyMatch ? keyMatch[1] : '';

  // Device ID (patterns seen: "ID. 00 1A 79 B7 1C 2D" or a 12-16 hex group possibly spaced)
  //  - Look for something after "ID" or "Device ID"
  let id = '';
  const idLabel = norm.match(/\b(?:device\s*id|id\.)[:\s]*([0-9a-fA-F\s]{12,})/i);
  if(idLabel){
    // keep only hex + spaces and collapse to pairs
    const onlyHex = idLabel[1].replace(/[^0-9a-fA-F\s]/g,' ').trim();
    // examples like "00 1A 79 B7 1C 2D" → keep with spaces AND provide compact
    const pairs = onlyHex.split(/\s+/).filter(x=>/^[0-9a-fA-F]{2}$/.test(x));
    if(pairs.length >= 6) id = pairs.join(' ').toUpperCase();
  } else {
    // fallback: a long hex run suggestive of ID without separators
    const compact = norm.match(/\b[0-9a-fA-F]{12,}\b/);
    if(compact) id = compact[0].toUpperCase();
  }
  didEl.textContent = id;

  if(!urlMatch && !mac && !keyMatch && !id){ setStatus('Rien trouvé. Essayez une image plus nette (plein écran, sans reflet).', 'warn'); }
  else { setStatus('Extraction terminée ✔', 'ok'); }
}

// UI events
drop.addEventListener('click', ()=> fileInput.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.classList.remove('drag');
  if(e.dataTransfer.files?.length){ fileInput.files = e.dataTransfer.files; preview.src = await readFile(fileInput.files[0]); }
});
fileInput.addEventListener('change', async ()=>{
  if(fileInput.files?.[0]) preview.src = await readFile(fileInput.files[0]);
});
el('#run').addEventListener('click', runOCR);
el('#clear').addEventListener('click', ()=>{
  fileInput.value=''; preview.removeAttribute('src'); resetOut(); setStatus('Prêt.');
});
</script>
</body>
</html>
