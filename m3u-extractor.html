<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extracteur IPTV + Générateur M3U — corrigé</title>
  <style>
    :root{--bg:#0b0f12;--card:#12171c;--muted:#8a97a6;--text:#e6edf3;--accent:#2f81f7;--ok:#2ea043;--warn:#e3b341;--err:#f85149;--border:#26303a}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);line-height:1.5}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .tabbar{display:flex;gap:8px;margin-bottom:16px}
    .tabbtn{padding:10px 14px;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;cursor:pointer}
    .tabbtn.active{outline:2px solid var(--accent)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px}
    h1{font-size:20px;margin:4px 0 8px}
    .lead{color:var(--muted);margin:0 0 12px}
    label{display:block;margin:12px 0 6px;color:var(--muted)}
    input[type="text"],input[type="url"],select,textarea{width:100%;background:#0e1318;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px}
    textarea{min-height:160px;resize:vertical}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
    button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#18202a;color:var(--text);cursor:pointer}
    button.secondary{background:#11161b}
    button:disabled{opacity:.6;cursor:not-allowed}
    .status{margin-top:8px;color:var(--muted)}
    .status.ok{color:var(--ok)}
    .status.warn{color:var(--warn)}
    .drop{display:flex;align-items:center;justify-content:center;border:1px dashed var(--border);border-radius:12px;padding:18px;min-height:68px;color:var(--muted);background:#0e1318}
    .drop.drag{border-color:var(--accent);color:var(--text)}

    /* === Extracteur: layout side-by-side on desktop === */
    .extractor-grid{display:grid;grid-template-columns:1fr;gap:14px;align-items:start}
    @media (min-width: 900px){
      .extractor-grid{grid-template-columns: 1.1fr .9fr}
    }
    .pane{display:flex;flex-direction:column;gap:10px}
    #preview{max-width:100%;border-radius:12px;border:1px solid var(--border);display:block}

    .result{display:flex;flex-direction:column;gap:8px}
    .row{display:grid;grid-template-columns:140px 1fr auto;gap:8px;align-items:center}
    .label{color:var(--muted)}
    .value{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .copybtn{white-space:nowrap}

    .extras{margin-top:12px;border-top:1px dashed var(--border);padding-top:12px}
    .extras .title{color:var(--muted);margin-bottom:8px}
    .row2{display:grid;grid-template-columns:1fr auto;gap:8px;margin:6px 0}

    #debugWrap{display:none;margin-top:12px}
    #debug{max-height:180px;overflow:auto;background:#0e1318;border:1px solid var(--border);border-radius:10px;padding:10px}

    .footer{color:var(--muted);margin-top:10px;font-size:13px}
    .switch{display:flex;align-items:center;gap:8px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="tabbar">
    <button class="tabbtn active" data-tab="extractor">Extracteur</button>
    <button class="tabbtn" data-tab="m3u">Générateur M3U</button>
  </div>

  <!-- Extracteur -->
  <section id="extractor" class="card" aria-labelledby="h-extractor">
    <h1 id="h-extractor">Extraction depuis capture d’écran IPTV</h1>
    <p class="lead">Téléversez l’image → obtenez <b>Site</b>, <b>MAC</b>, <b>Device Key</b>, <b>Device ID</b> via <b>OpenAI (proxy)</b>.</p>

    <label class="muted">Glissez-déposez/Téléchargez une image ici</label>
    <div id="drop" class="drop" tabindex="0" role="button" aria-label="Sélecteur d'image. Appuyez Entrée pour choisir.">
      <div>Glissez-déposez/Téléchargez une image ici</div>
      <input id="file" type="file" accept="image/*" aria-label="Choisir une image" hidden>
    </div>

    <div class="btns">
      <label class="switch" title="Activer pour prendre une photo directement">
        <input id="toggleCamera" type="checkbox"> Utiliser la caméra
      </label>
      <span id="status" class="status" aria-live="polite">Prêt.</span>
    </div>

    <!-- Side-by-side layout: left preview, right extracted fields -->
    <div class="extractor-grid">
      <div class="pane">
        <img id="preview" alt="Aperçu" loading="lazy">
        <div class="btns">
          <button id="runAi" type="button" class="secondary">Analyser avec OpenAI (proxy)</button>
          <button id="clear" type="button" class="secondary">Effacer</button>
        </div>
      </div>

      <div class="pane">
        <div class="result" aria-live="polite">
          <div class="row"><div class="label">Site</div><a id="siteLink" class="value" href="#" target="_blank" rel="noopener noreferrer"></a><button class="copybtn" type="button" data-copy="#siteLink" aria-label="Copier site">Copier</button></div>
          <div class="row"><div class="label">Adresse MAC</div><div id="mac" class="value"></div><button class="copybtn" type="button" data-copy="#mac" aria-label="Copier MAC">Copier</button></div>
          <div class="row"><div class="label">MAC (sans « : »)</div><div id="macplain" class="value"></div><button class="copybtn" type="button" data-copy="#macplain" aria-label="Copier MAC sans séparateurs">Copier</button></div>
          <div class="row"><div class="label">Clé appareil</div><div id="dkey" class="value"></div><button class="copybtn" type="button" data-copy="#dkey" aria-label="Copier Device Key">Copier</button></div>
          <div class="row"><div class="label">Device ID</div><div id="did" class="value"></div><button class="copybtn" type="button" data-copy="#did" aria-label="Copier Device ID">Copier</button></div>
        </div>

        <div id="debugWrap">
          <div class="muted">Debug</div>
          <pre id="debug"></pre>
        </div>

        <p class="footer">⚠️ Données sensibles : ne stockez/partagez que si vous avez le droit.</p>
      </div>
    </div>
  </section>

  <!-- M3U -->
  <section id="m3u" class="card" style="display:none">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <h1>Générateur de Template M3U</h1>
      <span id="m3uStatus" class="muted">En attente d'un lien…</span>
    </div>
    <p class="lead">Collez un <strong>seul</strong> lien M3U et générez un <strong>unique</strong> template.</p>

    <label for="playlistName">Nom de la playlist</label>
    <input type="text" id="playlistName" placeholder="Ex. Digistore" value="Digistore" />

    <label for="duration">Durée de test</label>
    <select id="duration"><option>1H</option><option>2H</option><option>3H</option><option>6H</option><option selected>12H</option><option>24H</option></select>

    <label for="m3uInput">Lien M3U</label>
    <input type="url" id="m3uInput" placeholder="Collez ici le lien M3U complet (http/https)…" inputmode="url" autocomplete="off" spellcheck="false"/>

    <div class="btns">
      <button id="generateBtn" type="button">Générer</button>
      <button id="copyBtn" type="button">Copier</button>
      <button id="clearBtn" type="button" class="secondary">Effacer</button>
    </div>

    <label for="output" style="margin-top:18px;">Template généré</label>
    <textarea id="output" readonly placeholder="Le template apparaîtra ici…"></textarea>

    <div class="extras">
      <div class="title">Copie rapide (valeurs seules)</div>
      <div class="row2"><input id="x_m3u" type="text" readonly placeholder="Lien M3U (brut)" /><button data-copy="#x_m3u" type="button">Copier M3U</button></div>
      <div class="row2"><input id="x_user" type="text" readonly placeholder="Username" /><button data-copy="#x_user" type="button">Copier Username</button></div>
      <div class="row2"><input id="x_pass" type="text" readonly placeholder="Password" /><button data-copy="#x_pass" type="button">Copier Password</button></div>
      <div class="row2"><input id="x_url" type="text" readonly placeholder="URL (avec port s'il existe)" /><button data-copy="#x_url" type="button">Copier URL</button></div>
      <div class="row2"><input id="x_combo" type="text" readonly placeholder="Username : X / Password : Y / URL : http://..." /><button data-copy="#x_combo" type="button">Copier la ligne</button></div>
    </div>

    <div class="footer">⚠️ Cette page formate uniquement vos informations. Elle ne vérifie pas la validité d’un abonnement.</div>
  </section>
</div>

<script>
/* ---------- Onglets ---------- */
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('section.card').forEach(s=> s.style.display = (s.id === tab) ? '' : 'none');
  });
});

/* ---------- Constantes & helpers ---------- */
const WORKER_URL = 'https://throbbing-voice-52a9.restless-cell-d69c.workers.dev';

const $  = (s)=> document.querySelector(s);
const $$ = (s)=> Array.from(document.querySelectorAll(s));

const statusEl = $('#status'), siteLink = $('#siteLink'), macEl = $('#mac'), macPlainEl = $('#macplain'), dkeyEl = $('#dkey'), didEl = $('#did');
const fileInput = $('#file'), drop = $('#drop'), preview = $('#preview');
const runAiBtn = $('#runAi'), clearBtn = $('#clear'), toggleCamera = $('#toggleCamera');
const debugWrap = $('#debugWrap'), debugEl = $('#debug');

let currentFile = null;
let isBusy = false;

function setStatus(text, cls=''){ statusEl.className='status '+(cls||''); statusEl.textContent=text; }
function showDebug(msg){ debugWrap.style.display='block'; const now = String(msg).slice(0, 2000); debugEl.textContent = (debugEl.textContent? debugEl.textContent+'\n':'') + now; }
function hideDebug(){ debugWrap.style.display='none'; debugEl.textContent=''; }

function normalizeHttpUrl(u){
  if(!u) return '';
  const s = String(u).trim();
  const hostLike = /^[a-z0-9.-]+\.[a-z]{2,}(?:\/.*)?$/i.test(s);
  const candidate = /^https?:\/\//i.test(s) ? s : (hostLike ? 'https://' + s : '');
  try {
    const url = new URL(candidate);
    if (url.protocol === 'http:' || url.protocol === 'https:') return url.toString();
  } catch(_) {}
  return '';
}

async function fetchWithTimeout(url, opts={}, ms=20000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  try { return await fetch(url, {...opts, signal: ctrl.signal}); }
  finally { clearTimeout(id); }
}
async function postImageWithRetry(body, tries=2){
  let lastErr;
  for (let i=0;i<tries;i++){
    try{
      const res = await fetchWithTimeout(WORKER_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify(body), cache:'no-cache', redirect:'follow'
      }, 20000);
      if (res.ok) return res;
      if ([429,500,502,503,504].includes(res.status)){
        await new Promise(r=>setTimeout(r, 600*(i+1)));
        continue;
      }
      return res;
    }catch(e){ lastErr = e; }
  }
  throw lastErr || new Error('Network failed');
}

function isLikelyImage(file){
  if (!file) return false;
  const okMime = /^image\/(png|jpe?g|webp|heic|gif)$/i.test(file.type);
  const okExt  = /\.(png|jpe?g|jpg|webp|heic|gif)$/i.test(file.name||'');
  return okMime || okExt;
}
function sanitizeMac(s){
  const hex = String(s||'').replace(/[^0-9a-f]/gi,'').slice(0,12).toUpperCase();
  if (hex.length !== 12) return '';
  return hex.match(/.{1,2}/g).join(':');
}
function sanitizeAscii(s, max=64){
  return String(s||'').replace(/[^\x20-\x7E]/g,'').slice(0,max).trim();
}
async function copyTextSafe(txt){
  try { await navigator.clipboard.writeText(txt); return true; }
  catch {
    const ta = document.createElement('textarea'); ta.value=txt; ta.style.position='fixed';
    document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    return true;
  }
}

function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function compressImageToDataURL(file, maxSize=1000, quality=0.68){
  const dataUrl = await readFileAsDataURL(file);
  const img = new Image();
  img.src = dataUrl;
  await new Promise(r => { img.onload = r; img.onerror = r; });

  const BASE64_LIMIT = 7 * 1024 * 1024; // ~7 Mo base64
  if (Math.max(img.width, img.height) <= maxSize && dataUrl.length < (3 * 1024 * 1024)) {
    return dataUrl;
  }

  const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
  const w = Math.round(img.width * scale), h = Math.round(img.height * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  let out = canvas.toDataURL('image/jpeg', quality);
  if (out.length > BASE64_LIMIT) { out = canvas.toDataURL('image/jpeg', 0.6); }
  return out;
}

/* ---------- App State ---------- */
function resetAppState() {
  isBusy = false;
  currentFile = null;
  fileInput.value = '';

  runAiBtn.disabled = false;
  preview.removeAttribute('src');
  siteLink.textContent=''; siteLink.removeAttribute('href');
  macEl.textContent=''; macPlainEl.textContent=''; dkeyEl.textContent=''; didEl.textContent='';

  setStatus('Prêt.');
  hideDebug();
}

window.addEventListener('pageshow', (event) => {
  if (event.persisted) {
    resetAppState();
  }
});

/* ---------- UI events ---------- */
// Toggle camera hint (+ accept tweak) 
function applyCameraAccept(){
  if (toggleCamera.checked){
    fileInput.setAttribute('capture','environment');
    fileInput.setAttribute('accept','image/*;capture=camera');
  } else {
    fileInput.removeAttribute('capture');
    fileInput.setAttribute('accept','image/*');
  }
}
applyCameraAccept();

toggleCamera.addEventListener('change', applyCameraAccept);

// Copy buttons (with fallback)
document.addEventListener('click', async (e)=>{
  const b = e.target.closest('[data-copy]'); if(!b) return;
  e.preventDefault();
  const node = document.querySelector(b.getAttribute('data-copy')); if(!node) return;
  const txt = (node.textContent || node.value || '').trim(); if(!txt) return;
  await copyTextSafe(txt);
  setStatus('Copié !','ok'); setTimeout(()=>setStatus('Prêt.'),900);
});

// Dropzone interactions
function openFilePicker(){ fileInput.click(); }

drop.addEventListener('click', openFilePicker);
drop.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); openFilePicker(); }});

drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', e=>{
  e.preventDefault(); drop.classList.remove('drag');
  handleFileSelect(e.dataTransfer.files && e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', ()=> handleFileSelect(fileInput.files[0]));

async function handleFileSelect(file) {
  if (!file) return;
  if (!isLikelyImage(file)) { setStatus('Fichier non reconnu comme image.', 'warn'); return; }
  resetAppState();
  currentFile = file;
  try {
    const durl = await readFileAsDataURL(currentFile);
    preview.src = durl;
    setStatus('Image chargée. Cliquez sur “Analyser”.');
    runAiBtn.focus();
  } catch (e) {
    setStatus('Erreur de lecture du fichier.', 'warn');
  }
}

/* ---------- Vision call ---------- */
async function runOpenAIVision(e){
  e?.preventDefault();
  if (isBusy) return;

  const file = currentFile || (fileInput.files && fileInput.files[0]);
  if(!file){ setStatus('Choisissez une image.', 'warn'); return; }

  hideDebug();
  setStatus('Analyse OpenAI…');
  isBusy = true;
  runAiBtn.disabled = true;

  try{
    const dataUrl = await compressImageToDataURL(file, 1000, 0.68);
    if (dataUrl.length > 7 * 1024 * 1024) {
      throw new Error('Image trop lourde après compression. Recadrez/réduisez.');
    }

    const res = await postImageWithRetry({ imageDataUrl: dataUrl });

    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      let msg = 'Erreur OpenAI/Proxy';
      try { const j = JSON.parse(txt); if (j?.error) msg = `${msg} : ${j.error} (status ${j.status || res.status})`; }
      catch { msg = `${msg} (HTTP ${res.status})`; }
      if (res.status === 413) msg = 'Image trop lourde. Réessayez après recadrage / réduction.';
      if (res.status === 429) msg = 'Limite atteinte. Réessayez dans quelques secondes.';
      setStatus(msg, 'warn');
      showDebug('HTTP '+res.status+'\n'+txt.slice(0,500));
      isBusy = false; runAiBtn.disabled = false; return;
    }

    const j = await res.json();

    siteLink.textContent=''; siteLink.removeAttribute('href');
    macEl.textContent=''; macPlainEl.textContent=''; dkeyEl.textContent=''; didEl.textContent='';

    const link = normalizeHttpUrl(j.site);
    if(link){ siteLink.textContent = link; siteLink.href = link; }

    const mac = sanitizeMac(j.mac);
    macEl.textContent = mac;
    macPlainEl.textContent = mac ? mac.replace(/:/g,'') : '';
    dkeyEl.textContent = sanitizeAscii(j.device_key, 64);
    didEl.textContent  = sanitizeAscii(j.device_id, 64);

    if(!siteLink.textContent && j){
      const guess = String(JSON.stringify(j)).replace(/[\u2013\u2014]/g,'-').match(/\b(?:https?:\/\/)?(?:[a-z0-9-]+\.)+[a-z]{2,}(?:\/[^\s"]*)?/i);
      if(guess){ const g = normalizeHttpUrl(guess[0]); if(g){ siteLink.textContent = g; siteLink.href = g; } }
    }

    setStatus('Terminé ✔', 'ok');

    // Amélioration UX: focus sur le premier bouton Copier
    const firstCopy = document.querySelector('.result .copybtn');
    if (firstCopy) firstCopy.focus();

  } catch(err) {
    if (err instanceof TypeError && String(err.message||'').includes('Failed to fetch')) {
      setStatus('Connexion perdue. Réessayez.', 'warn');
    } else {
      const msg = (err && (err.message || err.name)) ? `${err.name}: ${err.message}` : 'Échec réseau';
      setStatus('Erreur : ' + msg, 'warn');
      showDebug(String(err));
    }
  } finally {
    isBusy = false;
    runAiBtn.disabled = false;
  }
}

runAiBtn.addEventListener('click', runOpenAIVision);
clearBtn.addEventListener('click', (e) => {
  e.preventDefault();
  resetAppState();
  drop.focus();
});

/* ---------- Générateur M3U ---------- */
(function(){
  const $id = (id) => document.getElementById(id);
  const status = $id('m3uStatus'), nameInput = $id('playlistName'), durationSel = $id('duration'), urlInput = $id('m3uInput'), out = $id('output');
  const f_m3u = $id('x_m3u'), f_user = $id('x_user'), f_pass = $id('x_pass'), f_url = $id('x_url'), f_combo = $id('x_combo');

  function coerceHttpUrl(u){
    let s=(u||'').trim();
    if (!s) return '';
    if (!/^https?:\/\//i.test(s)) s = 'http://' + s;
    try { return new URL(s).toString(); } catch { return ''; }
  }

  function extract(u){
    const res = {username:'', password:'', origin:'', raw:''};
    try{
      const u2 = coerceHttpUrl(u);
      const url = new URL(u2);
      res.origin = url.origin;
      res.username = url.searchParams.get('username') || url.searchParams.get('user') || '';
      res.password = url.searchParams.get('password') || url.searchParams.get('pass') || '';
      res.raw = u;
    }catch(e){}
    return res;
  }

  function fillExtras(data){
    if(!data){ f_m3u.value = f_user.value = f_pass.value = f_url.value = f_combo.value = ''; return; }
    f_m3u.value = data.raw || '';
    f_user.value = data.username || '';
    f_pass.value = data.password || '';
    f_url.value  = data.origin || '';
    f_combo.value = `Username : ${data.username} / Password : ${data.password} / URL : ${data.origin}`;
  }

  function build(){
    const link = (urlInput.value||'').trim();
    if(!link){ status.textContent = "Aucun lien M3U fourni."; out.value=''; fillExtras(null); return; }
    const {username, password, origin, raw} = extract(link);
    const name = (nameInput.value||'Digistore').trim();
    const duration = (durationSel?.value || '12H');
    if(!origin || !username || !password){
      out.value = `Veuillez fournir un lien M3U valide avec "username" et "password".\n\nExemple :\nhttp://serveur:80/get.php?username=USER&password=PASS&type=m3u_plus&output=ts`;
      status.innerHTML = '<span class="warn">Lien invalide</span>'; fillExtras(null); return;
    }
    const nameLine = name ? `Nom de la playlist : ${name}\n` : '';
    out.value = `⚠️ TEST ${duration} ⚠️\n\n`+
              `➡️ Code :\n`+
              `${nameLine}`+
              `Nom d’utilisateur : ${username}\n`+
              `Mot de passe : ${password}\n`+
              `URL du serveur : ${origin} \n\n`+
              `➡️ Lien M3U :\n`+
              `${raw}`;
    status.innerHTML = '<span class="ok">Template prêt ✔</span>';
    fillExtras({raw, username, password, origin});
  }

  document.getElementById('generateBtn').addEventListener('click', build);
  document.getElementById('copyBtn').addEventListener('click', ()=> {
      if(!out.value) return;
      navigator.clipboard.writeText(out.value).then(()=>{
        const old = status.textContent; status.textContent = 'Copié !'; setTimeout(()=> status.textContent = old || '', 900);
      });
  });
  document.getElementById('clearBtn').addEventListener('click', ()=> { urlInput.value=''; out.value=''; fillExtras(null); status.textContent="En attente d'un lien…"; });
  urlInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); build(); }});
  urlInput.addEventListener('paste', ()=>{ setTimeout(build, 0); });
})();
</script>
</body>
</html>

