<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTV Utils — Extraction & M3U</title>
  <meta name="description" content="Extraction depuis image (OpenAI proxy) et Générateur de template M3U." />
  <style>
    :root { --bg:#0f1115; --card:#161a23; --text:#e9eef5; --muted:#9aa3b2; --accent:#4f8cff; --ok:#22c55e; --warn:#f59e0b; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Helvetica,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit}
    .container{max-width:1000px;margin:24px auto;padding:16px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
    .tabbtn{cursor:pointer;background:#2a3144;border:1px solid rgba(255,255,255,.06);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600}
    .tabbtn.active{background:var(--accent)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.35)}
    h1{margin:0 0 6px}
    p.lead{margin:0 0 14px;color:var(--muted)}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:var(--ok)} .warn{color:var(--warn)}
    button{cursor:pointer;border:0;border-radius:10px;padding:12px 16px;font-weight:600;color:white;background:var(--accent)}
    button.secondary{background:#2a3144}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Extracteur */
    .drop{position:relative;border:2px dashed rgba(255,255,255,.15);border-radius:14px;padding:20px;text-align:center;cursor:pointer; user-select:none;}
    .drop.drag{border-color:var(--accent);background:#0e1320}
    .drop input[type="file"]{position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;}
    .pick-row{display:flex;align-items:center;gap:10px;margin:8px 0 0 0;justify-content:center}
    .switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .switch input{width:20px;height:20px}

    img#preview{max-width:100%;border-radius:12px;margin-top:12px}
    .result{margin-top:16px;background:#0e1118;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:150px 1fr auto;gap:12px;align-items:center;padding:10px 0}
    .result .row + .row{border-top:1px solid rgba(255,255,255,.10);margin-top:10px;padding-top:14px}
    .row .label{color:var(--muted)}
    .row .value{font-family:ui-monospace,Menlo,Consolas,monospace;background:#101421;border-radius:8px;padding:10px 12px;min-height:42px;display:flex;align-items:center;word-break:break-all}
    .row a.value{color:var(--accent);text-decoration:none}
    .copybtn{background:#2a3144;padding:10px 12px;border-radius:8px;font-size:13px}
    .status{margin-top:10px;color:var(--muted)}
    .note{margin-top:14px;color:var(--muted);font-size:12px}

    #debugWrap{margin-top:10px;display:none}
    #debug{white-space:pre-wrap;background:#0c0f16;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:10px;font-size:12px;color:#9aa3b2}

    /* M3U */
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width: 720px){ .grid{grid-template-columns:1fr 1fr} }
    label{display:block;font-weight:600;margin:16px 0 8px}
    input[type="text"], input[type="url"], textarea, select{
      width:100%;background:#0e1118;color:var(--text);border:1px solid rgba(255,255,255,.08);
      border-radius:12px;padding:12px 14px;font-size:15px;outline:none;transition:border-color .2s
    }
    textarea{min-height:200px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:var(--accent)}
    .extras{margin-top:18px;display:grid;gap:12px}
    .extras .row2{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .extras .title{font-weight:600;margin-top:10px}
    .footer{margin-top:22px;font-size:12px;color:var(--muted);text-align:center}
  </style>
</head>
<body>
<div class="container">
  <div class="tabs">
    <button class="tabbtn active" data-tab="extractor">Extraction depuis image</button>
    <button class="tabbtn" data-tab="m3u">Générateur M3U</button>
  </div>

  <!-- Extracteur -->
  <section id="extractor" class="card">
    <h1>Extraction depuis capture d’écran IPTV</h1>
    <p class="lead">Téléversez l’image → obtenez <b>Site</b>, <b>MAC</b>, <b>Device Key</b>, <b>Device ID</b> via <b>OpenAI (proxy)</b>.</p>

    <label class="muted">Image</label>
    <div id="drop" class="drop" aria-label="Sélecteur d'image">
      <div>Touchez / cliquez pour choisir (galerie/fichiers) ou faites glisser une image ici</div>
      <input id="file" type="file" accept="image/*" aria-label="Choisir une image">
    </div>
    <div class="pick-row">
      <label class="switch" title="Activer pour prendre une photo directement">
        <input id="toggleCamera" type="checkbox"> Utiliser la caméra
      </label>
    </div>

    <img id="preview" alt="Aperçu">

    <div class="btns">
      <button id="runAi" type="button" class="secondary">Analyser avec OpenAI (proxy)</button>
      <button id="clear" type="button" class="secondary">Effacer</button>
    </div>
    <div id="status" class="status">Prêt.</div>

    <div class="result">
      <div class="row"><div class="label">Site</div><a id="siteLink" class="value" href="#" target="_blank" rel="noopener noreferrer"></a><span></span></div>
      <div class="row"><div class="label">Adresse MAC</div><div id="mac" class="value"></div><button class="copybtn" type="button" data-copy="#mac">Copier</button></div>
      <div class="row"><div class="label">MAC (sans « : »)</div><div id="macplain" class="value"></div><button class="copybtn" type="button" data-copy="#macplain">Copier</button></div>
      <div class="row"><div class="label">Clé appareil</div><div id="dkey" class="value"></div><button class="copybtn" type="button" data-copy="#dkey">Copier</button></div>
      <div class="row"><div class="label">Device ID</div><div id="did" class="value"></div><button class="copybtn" type="button" data-copy="#did">Copier</button></div>
    </div>

    <div id="debugWrap"><div class="muted">Debug</div><pre id="debug"></pre></div>

    <p class="note">Par défaut, vous choisissez dans la galerie/fichiers. Activez “Utiliser la caméra” pour ouvrir directement l’appareil photo.</p>
  </section>

  <!-- M3U -->
  <section id="m3u" class="card" style="display:none">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
      <h1>Générateur de Template M3U</h1>
      <span id="m3uStatus" class="muted">En attente d'un lien…</span>
    </div>
    <p class="lead">Collez un <strong>seul</strong> lien M3U et générez un <strong>unique</strong> template.</p>

    <label for="playlistName">Nom de la playlist</label>
    <input type="text" id="playlistName" placeholder="Ex. Digistore" value="Digistore" />

    <label for="duration">Durée de test</label>
    <select id="duration"><option>1H</option><option>2H</option><option>3H</option><option>6H</option><option selected>12H</option><option>24H</option></select>

    <label for="m3uInput">Lien M3U</label>
    <input type="url" id="m3uInput" placeholder="Collez ici le lien M3U complet (http/https)…" inputmode="url" autocomplete="off" spellcheck="false"/>

    <div class="btns">
      <button id="generateBtn" type="button">Générer</button>
      <button id="copyBtn" type="button">Copier</button>
      <button id="clearBtn" type="button" class="secondary">Effacer</button>
    </div>

    <label for="output" style="margin-top:18px;">Template généré</label>
    <textarea id="output" readonly placeholder="Le template apparaîtra ici…"></textarea>

    <div class="extras">
      <div class="title">Copie rapide (valeurs seules)</div>
      <div class="row2"><input id="x_m3u" type="text" readonly placeholder="Lien M3U (brut)" /><button data-copy="#x_m3u" type="button">Copier M3U</button></div>
      <div class="row2"><input id="x_user" type="text" readonly placeholder="Username" /><button data-copy="#x_user" type="button">Copier Username</button></div>
      <div class="row2"><input id="x_pass" type="text" readonly placeholder="Password" /><button data-copy="#x_pass" type="button">Copier Password</button></div>
      <div class="row2"><input id="x_url" type="text" readonly placeholder="URL (avec port s'il existe)" /><button data-copy="#x_url" type="button">Copier URL</button></div>
      <div class="row2"><input id="x_combo" type="text" readonly placeholder="Username : X / Password : Y / URL : http://..." /><button data-copy="#x_combo" type="button">Copier la ligne</button></div>
    </div>

    <div class="footer">⚠️ Cette page formate uniquement vos informations. Elle ne vérifie pas la validité d’un abonnement.</div>
  </section>
</div>

<script>
/* Tabs */
document.querySelectorAll('.tabbtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('section.card').forEach(s=> s.style.display = (s.id === tab) ? '' : 'none');
  });
});

/* ==== Extracteur ==== */
const WORKER_URL = 'https://throbbing-voice-52a9.restless-cell-d69c.workers.dev'; // ← ta vraie URL, SANS slash final

const $ = (s)=> document.querySelector(s);
const statusEl = $('#status');
const siteLink = $('#siteLink'), macEl = $('#mac'), macPlainEl = $('#macplain'), dkeyEl = $('#dkey'), didEl = $('#did');
const fileInput = $('#file'), drop = $('#drop'), preview = $('#preview');
const runAiBtn = $('#runAi'), clearBtn = $('#clear'), toggleCamera = $('#toggleCamera');
const debugWrap = $('#debugWrap'), debugEl = $('#debug');

let currentFile = null;
let isBusy = false;

function setStatus(text, cls=''){ statusEl.className='status '+(cls||''); statusEl.textContent=text; }
function showDebug(msg){ debugWrap.style.display='block'; debugEl.textContent = (debugEl.textContent? debugEl.textContent+'\n':'') + msg; }
function hideDebug(){ debugWrap.style.display='none'; debugEl.textContent=''; }

/* Caméra ON/OFF */
toggleCamera.addEventListener('change', ()=>{
  if(toggleCamera.checked){ fileInput.setAttribute('capture','environment'); }
  else { fileInput.removeAttribute('capture'); }
});

/* Copier */
document.addEventListener('click', e=>{
  const b = e.target.closest('[data-copy]'); if(!b) return;
  e.preventDefault();
  const node = document.querySelector(b.getAttribute('data-copy')); if(!node) return;
  const txt = node.textContent.trim(); if(!txt) return;
  navigator.clipboard?.writeText(txt);
  setStatus('Copié !','ok'); setTimeout(()=>setStatus('Prêt.'),900);
});

/* Reset résultats + libération mémoire */
function resetOut(){
  siteLink.textContent=''; siteLink.removeAttribute('href');
  macEl.textContent=''; macPlainEl.textContent=''; dkeyEl.textContent=''; didEl.textContent='';
}
async function microYield(){ return new Promise(r=> setTimeout(r,0)); } // laisse le GC respirer

/* Fichier → DataURL */
function readFileAsDataURL(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* Compression WebP (fallback JPEG) */
function canvasToDataURLSafe(canvas, prefer='image/webp', q=0.7){
  try{
    const supported = canvas.toDataURL(prefer, q);
    if (supported && supported.startsWith('data:image/webp')) return supported;
  }catch(_){} // certains navigateurs throw
  return canvas.toDataURL('image/jpeg', Math.min(Math.max(q,0.5),0.8));
}

async function compressImageToDataURL(file, maxSize=1000, quality=0.7){
  const dataUrl = await readFileAsDataURL(file);
  await microYield();

  const img = new Image();
  img.decoding = 'async';
  img.src = dataUrl;
  try { await img.decode(); } catch { await new Promise(r=>{ img.onload=r; img.onerror=r; }); }

  const width = img.naturalWidth || img.width;
  const height = img.naturalHeight || img.height;

  // Petite image => OK direct si < 2.8MB
  if (Math.max(width, height) <= maxSize && dataUrl.length < 2.8 * 1024 * 1024) {
    return dataUrl;
  }

  const scale = Math.min(1, maxSize / Math.max(width, height));
  const w = Math.round(width * scale), h = Math.round(height * scale);

  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);

  let out = canvasToDataURLSafe(canvas, 'image/webp', quality); // WebP si possible
  if (out.length > 3.2 * 1024 * 1024) { out = canvasToDataURLSafe(canvas, 'image/webp', 0.6); }
  canvas.width = canvas.height = 0; // aide le GC
  await microYield();
  return out;
}

/* Normaliser URL */
function normalizeUrlMaybe(u){
  if(!u) return '';
  const s = String(u).trim();
  if(/^https?:\/\//i.test(s)) return s;
  if(/^[a-z0-9.-]+\.[a-z]{2,}(?:\/.*)?$/i.test(s)) return 'https://' + s;
  return s;
}

/* Ping Worker (diag) */
async function pingWorker(){
  try { const res = await fetch(WORKER_URL + '/ping', { method:'GET', cache:'no-store' }); return res.ok; }
  catch (e) { showDebug('Ping échoué: '+(e.message||e)); return false; }
}

/* Retry helper (x3) */
async function fetchWithRetry(url, options, retries=2){
  let lastErr;
  for(let i=0;i<=retries;i++){
    try{
      const res = await fetch(url, options);
      if(!res.ok) return res; // status != 2xx -> on renvoie direct (géré ailleurs)
      return res;
    }catch(e){
      lastErr = e;
      // Types d’erreurs “réseau” à retenter
      const msg = (e && (e.message||e.name||'error')).toString();
      if(!/TypeError|ProgressEvent|NetworkError|Failed to fetch/i.test(msg)) break;
      await new Promise(r=> setTimeout(r, 200 * Math.pow(3,i))); // 200ms -> 600ms -> 1800ms
    }
  }
  throw lastErr || new Error('Network failed');
}

/* Analyse */
async function runOpenAIVision(e){
  e?.preventDefault();
  if (isBusy) return;

  const file = currentFile || (fileInput.files && fileInput.files[0]);
  if(!file){ setStatus('Choisissez une image.', 'warn'); return; }

  // Reset fort avant de commencer
  resetOut(); hideDebug();
  setStatus('Analyse OpenAI…');
  isBusy = true; runAiBtn.disabled = true;

  try{
    const pingOk = await pingWorker();
    if (!pingOk) setStatus('Ping KO, tentative quand même…');

    const dataUrl = await compressImageToDataURL(file, 1000, 0.7);

    // Garde-fou dur pour Workers (10MB max body). On reste < ~3.5MB coté client.
    if (dataUrl.length > 3.8 * 1024 * 1024) {
      setStatus('Image trop lourde après compression. Recadre/réduis.', 'warn');
      showDebug('DataURL length: ' + dataUrl.length);
      return;
    }

    // Aperçu (DataURL stable)
    preview.src = dataUrl;

    const res = await fetchWithRetry(WORKER_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept':'application/json' },
      body: JSON.stringify({ imageDataUrl: dataUrl }),
      cache: 'no-store',
      redirect: 'follow',
      keepalive: false
    }, 2);

    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      let msg = 'Erreur OpenAI/Proxy';
      try { const j = JSON.parse(txt); if (j?.error) msg = `${msg} : ${j.error} (status ${j.status || res.status})`; }
      catch { msg = `${msg} (HTTP ${res.status})`; }
      if (res.status === 413) msg = 'Image trop lourde. Recadre / réduis.';
      setStatus(msg, 'warn');
      showDebug('HTTP '+res.status+'\n'+txt.slice(0,500));
      return;
    }

    const j = await res.json();

    const link = normalizeUrlMaybe(j.site);
    if(link){ siteLink.textContent = link; siteLink.href = link; }

    const mac = (j.mac || '').toLowerCase();
    macEl.textContent = mac;
    macPlainEl.textContent = mac ? mac.replace(/:/g,'').toUpperCase() : '';
    dkeyEl.textContent = j.device_key || '';
    didEl.textContent  = j.device_id || '';

    if(!siteLink.textContent && j){
      const guess = String(JSON.stringify(j)).replace(/[\u2013\u2014]/g,'-').match(/\b(?:https?:\/\/)?(?:[a-z0-9-]+\.)+[a-z]{2,}(?:\/[^\s"]*)?/i);
      if(guess){ const g = normalizeUrlMaybe(guess[0]); siteLink.textContent = g; siteLink.href = g; }
    }

    setStatus('Terminé ✔', 'ok');
  }catch(err){
    const msg = (err && (err.message || err.name)) ? `${err.name}: ${err.message}` : 'Échec réseau';
    setStatus('Erreur réseau : ' + msg, 'warn');
    showDebug(String(err));
  }finally{
    // Libération mémoire “agressive” pour éviter les soucis au 2ᵉ essai
    await microYield();
    isBusy = false; runAiBtn.disabled = false;
  }
}

/* Sélection fichier */
fileInput.addEventListener('change', async ()=>{
  if(fileInput.files?.length){
    currentFile = fileInput.files[0];
    const durl = await readFileAsDataURL(currentFile);
    preview.src = durl;
    hideDebug();
    isBusy = false; runAiBtn.disabled = false;
    setStatus('Image chargée. Cliquez “Analyser avec OpenAI (proxy)”.');
  }
});

/* Drag & drop */
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('drag'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
drop.addEventListener('drop', async e=>{
  e.preventDefault(); drop.classList.remove('drag');
  if(e.dataTransfer.files?.length){
    currentFile = e.dataTransfer.files[0];
    const durl = await readFileAsDataURL(currentFile);
    preview.src = durl;
    fileInput.value = ''; // permet de re-choisir le même fichier
    hideDebug();
    isBusy = false; runAiBtn.disabled = false;
    setStatus('Image chargée. Cliquez “Analyser avec OpenAI (proxy)”.');
  }
});

/* Boutons */
runAiBtn.addEventListener('click', runOpenAIVision);
clearBtn.addEventListener('click', async (e)=>{
  e.preventDefault();
  // reset fort pour que les essais suivants fonctionnent
  fileInput.value=''; currentFile=null;
  preview.removeAttribute('src');
  resetOut(); hideDebug();
  isBusy = false; runAiBtn.disabled = false;
  await microYield();
  setStatus('Prêt.');
});

/* ==== M3U (inchangé) ==== */
(function(){
  const $id = (id) => document.getElementById(id);
  const status = $id('m3uStatus'), nameInput = $id('playlistName'), durationSel = $id('duration'), urlInput = $id('m3uInput'), out = $id('output');
  const f_m3u = $id('x_m3u'), f_user = $id('x_user'), f_pass = $id('x_pass'), f_url = $id('x_url'), f_combo = $id('x_combo');

  function extract(u){
    const res = {username:'', password:'', origin:'', raw:''};
    try{
      const url = new URL(u);
      const m = /^([a-z]+:)(\/\/)?([^/]+)/i.exec(u);
      const protoRaw = (m && m[1]) ? m[1].toLowerCase() : (url.protocol || 'http:');
      const proto = protoRaw.endsWith(':') ? protoRaw + '//' : protoRaw;
      const hostPort = m ? m[3] : (url.host || '');
      res.origin = proto + hostPort;
      res.username = url.searchParams.get('username') || url.searchParams.get('user') || '';
      res.password = url.searchParams.get('password') || url.searchParams.get('pass') || '';
      res.raw = u;
    }catch(e){}
    return res;
  }

  function build(){
    const link = (urlInput.value||'').trim();
    if(!link){ status.textContent = "Aucun lien M3U fourni."; out.value=''; fillExtras(null); return; }
    const {username, password, origin, raw} = extract(link);
    const name = (nameInput.value||'Digistore').trim();
    const duration = (durationSel?.value || '12H');
    if(!origin || !username || !password){
      out.value = `Veuillez fournir un lien M3U valide avec "username" et "password".\n\nExemple :\nhttp://serveur:80/get.php?username=USER&password=PASS&type=m3u_plus&output=ts`;
      status.innerHTML = '<span class="warn">Lien invalide</span>'; fillExtras(null); return;
    }
    const nameLine = name ? `Nom de la playlist : ${name}\n` : '';
    out.value = `⚠️ TEST ${duration} ⚠️\n\n`+
                `➡️ Code :\n`+
                `${nameLine}`+
                `Nom d’utilisateur : ${username}\n`+
                `Mot de passe : ${password}\n`+
                `URL du serveur : ${origin} \n\n`+
                `➡️ Lien M3U :\n`+
                `${raw}`;
    status.innerHTML = '<span class="ok">Template prêt ✔</span>';
    fillExtras({raw, username, password, origin});
  }

  function fillExtras(data){
    if(!data){ f_m3u.value = f_user.value = f_pass.value = f_url.value = f_combo.value = ''; return; }
    f_m3u.value = data.raw || '';
    f_user.value = data.username || '';
    f_pass.value = data.password || '';
    f_url.value  = data.origin || '';
    f_combo.value = `Username : ${data.username} / Password : ${data.password} / URL : ${data.origin}`;
  }

  function copyPlain(text, onDone){
    if(!text) return;
    const done = () => { if(onDone) onDone(); };
    if(navigator.clipboard && window.isSecureContext){ navigator.clipboard.writeText(text).then(done).catch(fallback); }
    else { fallback(); }
    function fallback(){
      const ta = document.createElement('textarea');
      ta.value = text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.opacity='0';
      document.body.appendChild(ta); ta.focus(); ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta); done();
    }
  }

  function copyFromSelector(sel){
    const el = document.querySelector(sel); if(!el) return;
    copyPlain(el.value||'', () => {
      const old = status.textContent; status.textContent = 'Copié !';
      setTimeout(()=> status.textContent = old || '', 900);
    });
  }

  function clearAll(){ urlInput.value=''; out.value=''; fillExtras(null); status.textContent="En attente d'un lien…"; }

  document.getElementById('generateBtn').addEventListener('click', build);
  document.getElementById('copyBtn').addEventListener('click', ()=> copyPlain(out.value||'', () => {
    const old = status.textContent; status.textContent = 'Copié !'; setTimeout(()=> status.textContent = old || '', 900);
  }));
  document.getElementById('clearBtn').addEventListener('click', clearAll);
  document.addEventListener('click', (e)=>{ const btn = e.target.closest('button[data-copy]'); if(!btn) return; const sel = btn.getAttribute('data-copy'); copyFromSelector(sel); });
  urlInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); build(); }});
  urlInput.addEventListener('paste', ()=>{ setTimeout(build, 0); });
})();
</script>
</body>
</html>

